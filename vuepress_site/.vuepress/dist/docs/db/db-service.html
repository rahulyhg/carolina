<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The DB Service | Carolina Documentation</title>
    <meta name="description" content="Documentation for the Carolina web framework.">
    
    
    <link rel="preload" href="/assets/css/styles.4c99cee3.css" as="style"><link rel="preload" href="/assets/js/app.4c99cee3.js" as="script"><link rel="preload" href="/assets/js/27.aff06937.js" as="script"><link rel="prefetch" href="/assets/js/1.1cf9f1db.js"><link rel="prefetch" href="/assets/js/10.67736b9c.js"><link rel="prefetch" href="/assets/js/11.7beeac27.js"><link rel="prefetch" href="/assets/js/12.8ffce904.js"><link rel="prefetch" href="/assets/js/13.54a86374.js"><link rel="prefetch" href="/assets/js/14.f6222131.js"><link rel="prefetch" href="/assets/js/15.60843f1a.js"><link rel="prefetch" href="/assets/js/16.3bab9827.js"><link rel="prefetch" href="/assets/js/17.371a0e2c.js"><link rel="prefetch" href="/assets/js/18.2bf4752f.js"><link rel="prefetch" href="/assets/js/19.d7b2b433.js"><link rel="prefetch" href="/assets/js/2.d296c8c8.js"><link rel="prefetch" href="/assets/js/20.84f7874a.js"><link rel="prefetch" href="/assets/js/21.b063a67b.js"><link rel="prefetch" href="/assets/js/22.75e8e46c.js"><link rel="prefetch" href="/assets/js/23.c3543ea8.js"><link rel="prefetch" href="/assets/js/24.5c5f18c8.js"><link rel="prefetch" href="/assets/js/25.64098a0b.js"><link rel="prefetch" href="/assets/js/26.e2acfd13.js"><link rel="prefetch" href="/assets/js/28.8bc12e94.js"><link rel="prefetch" href="/assets/js/29.c7890b85.js"><link rel="prefetch" href="/assets/js/3.79b6242f.js"><link rel="prefetch" href="/assets/js/30.1c7523a4.js"><link rel="prefetch" href="/assets/js/31.41d153ce.js"><link rel="prefetch" href="/assets/js/32.076ea23e.js"><link rel="prefetch" href="/assets/js/33.4df50c49.js"><link rel="prefetch" href="/assets/js/34.afd39df7.js"><link rel="prefetch" href="/assets/js/35.96ad804d.js"><link rel="prefetch" href="/assets/js/36.4b18f55f.js"><link rel="prefetch" href="/assets/js/37.785cf241.js"><link rel="prefetch" href="/assets/js/38.8ff035ad.js"><link rel="prefetch" href="/assets/js/39.e0c013ee.js"><link rel="prefetch" href="/assets/js/4.455a7b47.js"><link rel="prefetch" href="/assets/js/40.141dd392.js"><link rel="prefetch" href="/assets/js/41.c0c4f533.js"><link rel="prefetch" href="/assets/js/42.a505c995.js"><link rel="prefetch" href="/assets/js/43.9538af71.js"><link rel="prefetch" href="/assets/js/44.4a09b0cb.js"><link rel="prefetch" href="/assets/js/45.01328d52.js"><link rel="prefetch" href="/assets/js/46.d54fdc6d.js"><link rel="prefetch" href="/assets/js/47.93af6532.js"><link rel="prefetch" href="/assets/js/48.3aecbfc9.js"><link rel="prefetch" href="/assets/js/49.030d249e.js"><link rel="prefetch" href="/assets/js/5.39ac8b79.js"><link rel="prefetch" href="/assets/js/50.830dbfe7.js"><link rel="prefetch" href="/assets/js/51.8883ddf5.js"><link rel="prefetch" href="/assets/js/52.0e11daf2.js"><link rel="prefetch" href="/assets/js/53.fc4fea9f.js"><link rel="prefetch" href="/assets/js/54.224ab9d2.js"><link rel="prefetch" href="/assets/js/55.57f73974.js"><link rel="prefetch" href="/assets/js/56.f67ded59.js"><link rel="prefetch" href="/assets/js/6.53b715ea.js"><link rel="prefetch" href="/assets/js/7.3c48cb9f.js"><link rel="prefetch" href="/assets/js/8.23ab337a.js"><link rel="prefetch" href="/assets/js/9.01843353.js">
    <link rel="stylesheet" href="/assets/css/styles.4c99cee3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      Carolina Documentation
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Documentation</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">Tutorial</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Documentation</a></div><div class="nav-item"><a href="/tutorials/" class="nav-link">Tutorial</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Getting Started</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Framework Overview</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Basics</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Authentication</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Advanced</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Databases</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/docs/db/db-service.html" class="active sidebar-link">The DB Service</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/db/db-service.html#connection-configuration" class="sidebar-link">Connection Configuration</a></li><li class="sidebar-sub-header"><a href="/docs/db/db-service.html#database-operations" class="sidebar-link">Database Operations</a></li><li class="sidebar-sub-header"><a href="/docs/db/db-service.html#database-logs" class="sidebar-link">Database Logs</a></li></ul></li><li><a href="/docs/db/schemas.html" class="sidebar-link">Schemas and Fields</a></li><li><a href="/docs/db/models.html" class="sidebar-link">Models</a></li><li><a href="/docs/db/queries.html" class="sidebar-link">Database Queries</a></li><li><a href="/docs/db/fixtures.html" class="sidebar-link">Fixtures</a></li><li><a href="/docs/db/relations.html" class="sidebar-link">Reference Fields</a></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Included Plugins</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="the-db-service"><a href="#the-db-service" aria-hidden="true" class="header-anchor">#</a> The DB Service</h1><p>The Database (or &quot;DB&quot;) Service manages access to instances of Models that
are stored in databases. It manages a set of database connections, which
are configured in <code>config/db.js</code>.</p><p>The framework comes with two connection types:</p><ul><li><code>JsonConnection</code>: The starting default. Stores the &quot;database&quot; as JSON files in the <code>data/</code> directory. Should only be used for very small scale testing.</li><li><code>MongoDbConnection</code>: Connects to a MongoDB instance.</li></ul><p></p><div class="table-of-contents"><ul><li><a href="#connection-configuration">Connection Configuration</a><ul><li><a href="#mutiple-connections">Mutiple Connections</a></li></ul></li><li><a href="#database-operations">Database Operations</a><ul><li><a href="#listing-records">Listing Records</a></li><li><a href="#getting-a-record-by-id">Getting a Record by Id</a></li><li><a href="#updating-records">Updating Records</a></li><li><a href="#creating-a-record">Creating a Record</a></li><li><a href="#deleting-records">Deleting Records</a></li></ul></li><li><a href="#database-logs">Database Logs</a></li></ul></div><p></p><h2 id="connection-configuration"><a href="#connection-configuration" aria-hidden="true" class="header-anchor">#</a> Connection Configuration</h2><p>Database connections are configured in the <code>connections</code> property
of <code>config/db.js</code>. It is an object mapping connection names to their
configurations. You can have as many connections as needed, but one called
&quot;default&quot; must exist.</p><p><strong><code>JsonConnection</code> Configuration</strong></p><p>To configure an instance of <code>JsonConnection</code>, you must supply a path
to a directory. The path will be interpreted with the current working directory
set to your project root and should point to a directory.</p><p>Example:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  driver<span class="token punctuation">:</span> <span class="token string">'JsonConnection'</span><span class="token punctuation">,</span>
  path<span class="token punctuation">:</span> <span class="token string">'./data/main/'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>With this configuration, files like <code>user.json</code> and <code>log_entry.json</code> will be
created in <code>data/main/</code> to be the database.</p><p><strong><code>MongoDbConnection</code> Configuration</strong></p><p>To configure an instance of <code>MongoDbConnection</code>, you may need to identify the
<code>host</code>, <code>port</code>, and <code>dbName</code>. The default is a database called &quot;main&quot;
on <code>localhost:27017</code>. You can also specify a <code>clientOptions</code> property,
which will be passed into the second argument of the constructor
for <code>MongoClient</code> from the <a href="https://www.npmjs.com/package/mongodb" target="_blank" rel="noopener noreferrer">mongodb<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
NPM module (this may be necessary for supplying a username and password
for example).</p><p>Example:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
  driver<span class="token punctuation">:</span> <span class="token string">'MongoDbConnection'</span><span class="token punctuation">,</span>
  host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> <span class="token number">27017</span><span class="token punctuation">,</span>
  dbName<span class="token punctuation">:</span> <span class="token string">'main'</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="mutiple-connections"><a href="#mutiple-connections" aria-hidden="true" class="header-anchor">#</a> Mutiple Connections</h3><p>You can have more than one DB Connection, but normally the &quot;default&quot; one is
used for everything. You can specify that certain tables belong to certain
connections in the <code>connectionMap</code> property of <code>config/db.js</code>. For example,
you could define a &quot;userdb&quot; connection in <code>connections</code>, and reference it
for Users:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code>exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  connections<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">'default'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      driver<span class="token punctuation">:</span> <span class="token string">'JsonConnection'</span><span class="token punctuation">,</span>
      path<span class="token punctuation">:</span> <span class="token string">&quot;./data/main/&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">'userdb'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      driver<span class="token punctuation">:</span> <span class="token string">'MongoDbConnection'</span><span class="token punctuation">,</span>
      <span class="token comment">// default host and port</span>
      dbName<span class="token punctuation">:</span> <span class="token string">'auth'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  
  connectionMap<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">:</span> <span class="token string">'userdb'</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>The table name associated with each Model class is specified in the Model's
Schema. Under this example configuration, objects of the User model will be
stored in the local MongoDB database &quot;auth&quot;, and all other models will
be stored in local JSON files.</p><h2 id="database-operations"><a href="#database-operations" aria-hidden="true" class="header-anchor">#</a> Database Operations</h2><p>Generally, you should use Model classes to perform Database operations, which
is covered in a later section. You can use the DB Service to directly
do stuff on the database.</p><p>You can get a reference to the DB Service from the Carolina global object:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> DBSvc <span class="token operator">=</span> Carolina<span class="token punctuation">.</span><span class="token function">$</span><span class="token punctuation">(</span><span class="token string">'DB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Every data for every Model instance has three forms, also described in more
detail in a later section. Those forms are DB Form, Object From, and JSON
Form. For example, a <code>DateField</code> entry is a Javascript Date in DB Form,
a <a href="https://www.npmjs.com/package/moment" target="_blank" rel="noopener noreferrer">moment<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> object in Object Form,
and a string timestamp in JSON Form. When dealing with the DB Service directory,
everything is in DB Form and returned objects will be plain objects
not Model class instances.</p><p>It is the methods of the Model class that translate
data between forms and instantiate instances.</p><div class="danger custom-block"><p class="custom-block-title">WARNING</p><p>You will need to be careful when inserting or updating records in tables
that are bound to Models. Schemas are not enforced when dealing with the
DB Service directly.</p></div><h3 id="listing-records"><a href="#listing-records" aria-hidden="true" class="header-anchor">#</a> Listing Records</h3><p>You can get a list of all records in a table using the
<code>async _all(tableName)</code> method. Be careful about doing this against large
tables.</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> allUsers <span class="token operator">=</span> <span class="token keyword">await</span> DBSvc<span class="token punctuation">.</span><span class="token function">_all</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>More precise queries and pagination are covered in later sections of this
documentation.</p></div><h3 id="getting-a-record-by-id"><a href="#getting-a-record-by-id" aria-hidden="true" class="header-anchor">#</a> Getting a Record by Id</h3><p>Each Connection type has a way of working with IDs. Every object in a
table has an ID. You can look up a specific object based on ID using the
<code>async _lookup(tableName, id)</code> method:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> id <span class="token operator">=</span> <span class="token comment">// some id</span>
<span class="token keyword">let</span> specificUser <span class="token operator">=</span> <span class="token keyword">await</span> DBSvc<span class="token punctuation">.</span><span class="token function">_lookup</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="updating-records"><a href="#updating-records" aria-hidden="true" class="header-anchor">#</a> Updating Records</h3><p>You can update any records that match a certain query using the
<code>async _update(tableName, query, update)</code> method:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// make user100 an admin user and set emailVerified to true</span>
<span class="token keyword">await</span> DBSvc<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> username<span class="token punctuation">:</span> <span class="token string">'user100'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  emailVerified<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  isAdmin<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="creating-a-record"><a href="#creating-a-record" aria-hidden="true" class="header-anchor">#</a> Creating a Record</h3><p>You can create a record in a table using the <code>async _create(tableName, object)</code>
method. It will return the ID of the newly created object.</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> newUserId <span class="token operator">=</span> <span class="token keyword">await</span> DBSvc<span class="token punctuation">.</span><span class="token function">_create</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  username<span class="token punctuation">:</span> <span class="token string">'user100'</span><span class="token punctuation">,</span>
  emailAddress<span class="token punctuation">:</span> <span class="token string">'user100@example.com'</span><span class="token punctuation">,</span>
  isAdmin<span class="token punctuation">:</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="deleting-records"><a href="#deleting-records" aria-hidden="true" class="header-anchor">#</a> Deleting Records</h3><p>You can delete any objects that match a query using the
<code>async _delete(tableName, query)</code> method:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// delete all non-admin users</span>
<span class="token keyword">let</span> deletedCount <span class="token operator">=</span> DBSvc<span class="token punctuation">.</span><span class="token function">_delete</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> isAdmin<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="database-logs"><a href="#database-logs" aria-hidden="true" class="header-anchor">#</a> Database Logs</h2><p>The Database Service creates logs using the Logger Service. All read-only
actions are logged at SILLY level, all write actions are logged at DEBUG
level, and queries for single objects that return no results are logged at
WARN level. The &quot;source&quot; for all such logs is &quot;DB&quot;.</p></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/docs/advanced/requests.html" class="prev">
          The Requests Service
        </a></span><span class="next"><a href="/docs/db/schemas.html">
          Schemas and Fields
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/app.4c99cee3.js" defer></script><script src="/assets/js/27.aff06937.js" defer></script>
  </body>
</html>
