(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{167:function(e,t,a){"use strict";a.r(t);var s=a(0),n=Object(s.a)({},function(){this.$createElement;this._self._c;return this._m(0)},[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticClass:"content"},[a("h1",{attrs:{id:"middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Middleware")]),a("p",[e._v("Middleware are classes that operate HTTP request and response objects both\nbefore and after the request is handled by its controller.\nMiddleware classes are capable of rejected a call entirely, for example if the\nroute requires a user to be logged in.")]),a("p",[e._v("You can specify configuration on each route that can be used to alter the\nbehavior of middleware.")]),a("p",[e._v("In addition to allowing you to create your own,\nthe Carolina framework includes the following middleware that you can\nuse:")]),a("table",[a("thead",[a("tr",[a("th",[e._v("Name")]),a("th",[e._v("Purpose")])])]),a("tbody",[a("tr",[a("td",[a("code",[e._v("CookieEncryptionMiddleware")])]),a("td",[e._v('Encrypts all outgoing cookies that start with "carolina" and decrypts all incoming cookies that start with "carolina".')])]),a("tr",[a("td",[a("code",[e._v("CookieMiddleware")])]),a("td",[e._v("Extracts all cookies from the HTTP request header and puts them into an object as "),a("code",[e._v("request.cookies")]),e._v(".")])]),a("tr",[a("td",[a("code",[e._v("CsrfMiddleware")])]),a("td",[e._v("Enforces the existence of a valid CSRF token in the request header or data body for all POST, PUT, PATCH, and DELETE requests.")])]),a("tr",[a("td",[a("code",[e._v("LogRequestsMiddleware")])]),a("td",[e._v("Logs incoming HTTP requests at the VERBOSE level.")])]),a("tr",[a("td",[a("code",[e._v("ModelExtractionMiddleware")])]),a("td",[e._v("Extracts the model instance based on the ID in one of the route parameters.")])]),a("tr",[a("td",[a("code",[e._v("SessionMiddleware")])]),a("td",[e._v("Provides the session as "),a("code",[e._v("request.session")]),e._v(" for incoming requests and stores the session from all outgoing responses.")])])])]),a("h2",{attrs:{id:"custom-middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#custom-middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Custom Middleware")]),a("p",[e._v("Your middleware should be defined in the "),a("code",[e._v("site/http/middleware")]),e._v(" directory\nand exported by name in "),a("code",[e._v("site/http/middleware/index.js")]),e._v(".")]),a("p",[e._v("You can create middleware using the CLI shortcut:")]),a("p",[a("code",[e._v("node . generate middleware ExampleMiddleware")])]),a("p",[e._v('An example middleware (that logs all incoming requests) might look like this\n(in fact, the actual "LogRequestsMiddleware" looks very much like this except\nthat is uses the Logger Service to send the log):')]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" BaseMiddleware "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'carolina/main/http/middleware/base-middleware'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("LogRequestsMiddleware")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("extends")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("BaseMiddleware")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("before")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// do nothing for incoming requests")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  \n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("async")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("after")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// log the request on the way out")]),e._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token string"}},[e._v("`http-request from ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("${")]),e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("ipAddress"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v(" for ")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("${")]),e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("url"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v(" (")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("${")]),e._v("response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("status"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[e._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v(")`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\nexports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" LogRequestsMiddleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("div",{staticClass:"tip custom-block"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),a("p",[e._v("This particular middleware already exists.")])]),a("p",[e._v("Note that the "),a("code",[e._v("before")]),e._v(" method must return the request and the "),a("code",[e._v("after")]),e._v(" method\nmust return the response.")]),a("p",[e._v("To ensure that this middleware is referable by name, it must be\nexported in "),a("code",[e._v("site/http/middleware/index.js")]),e._v(":")]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  LogRequestsMiddleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./log-requests-middleware.js'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("h2",{attrs:{id:"declaring-middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#declaring-middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Declaring Middleware")]),a("p",[e._v("All middleware is referenced by a unique name. The builtin middleware that\ncomes with Carolina is listed above. Your middleware should be exposed by\n"),a("code",[e._v("site/http/middleware/index.js")]),e._v(" and is referenced by key name. Middleware from\nany installed plugins will also be available as\n"),a("code",[e._v("<plugin_name>/MiddlewareClassName")]),e._v(" (by convention).")]),a("h3",{attrs:{id:"sitewide-middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sitewide-middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Sitewide Middleware")]),a("p",[e._v("Any middleware that you want to run against all routes should be listed\nby name in the "),a("code",[e._v("sitewide_middleware")]),e._v(" property exposed by\n"),a("code",[e._v("config/http.js")]),e._v(".")]),a("h3",{attrs:{id:"route-group-middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#route-group-middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Route Group Middleware")]),a("p",[e._v("The "),a("code",[e._v("middleware_groups")]),e._v(" property of the HTTP config is an object mapping\nroute group names to lists of middleware names.\nThey should correspond to the named route groups exposed by\n"),a("code",[e._v("site/http/routes/index.js")]),e._v(". If a route group name matches the name of a\nmiddleware group, that middleware will be applied to all routes in the group.")]),a("h3",{attrs:{id:"route-specific-middleware"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#route-specific-middleware","aria-hidden":"true"}},[e._v("#")]),e._v(" Route Specific Middleware")]),a("p",[e._v("When declaring routes, you can specify a list of middleware that should apply\nto that specific route:")]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[e._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" module"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("exports "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// other routes")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    route"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/some/route"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    controller"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"SomeController"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    middleware"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"SomeMiddleware"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n    data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])])]),a("p",[e._v("The middleware provided will be applied.")]),a("h3",{attrs:{id:"middleware-execution-order"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#middleware-execution-order","aria-hidden":"true"}},[e._v("#")]),e._v(" Middleware Execution Order")]),a("p",[e._v("As request comes in to your application, it goes through middleware and the\ncontroller in the following order:")]),a("ol",[a("li",[e._v("Request received from client.")]),a("li",[e._v("The "),a("code",[e._v("before")]),e._v(" method of all sitewide middleware, in the order defined in the config value "),a("code",[e._v("http.sitewide_middleware")]),e._v(".")]),a("li",[e._v("The "),a("code",[e._v("before")]),e._v(" method of any route group middleware for the specific route's group, in the order defined for the group in the config value "),a("code",[e._v("http.middleware_groups")]),e._v(".")]),a("li",[e._v("The "),a("code",[e._v("before")]),e._v(" method of any middleware defined for the specific route, in the order provided.")]),a("li",[e._v("The "),a("code",[e._v("before")]),e._v(" method of any middleware defined for the specific controller, in the order provided.")]),a("li",[e._v("The "),a("code",[e._v("handle")]),e._v(" method of the controller.")]),a("li",[e._v("The "),a("code",[e._v("after")]),e._v(" method of controller-specific middleware in reverse order.")]),a("li",[e._v("The "),a("code",[e._v("after")]),e._v(" method of route-specific middleware in reverse order.")]),a("li",[e._v("The "),a("code",[e._v("after")]),e._v(" method of route group middleware in reverse order.")]),a("li",[e._v("The "),a("code",[e._v("after")]),e._v(" method of sitewide middleware in reverse order.")]),a("li",[e._v("Response sent to client.")])]),a("h2",{attrs:{id:"custom-route-data"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#custom-route-data","aria-hidden":"true"}},[e._v("#")]),e._v(" Custom Route Data")]),a("p",[e._v("The middleware is configurable by data that goes with the route.\nThe "),a("code",[e._v("data")]),e._v(" property assigned to the relevant route is passed to the middleware\nfunctions (as the 2nd argument to "),a("code",[e._v("before")]),e._v(" and the 3rd argument to "),a("code",[e._v("after")]),e._v(").")]),a("h2",{attrs:{id:"stopping-request-progress"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#stopping-request-progress","aria-hidden":"true"}},[e._v("#")]),e._v(" Stopping Request Progress")]),a("p",[e._v("If in the middleware it is determined that the route should not proceed,\nyou can terminate it by setting "),a("code",[e._v("request.shouldContinue")]),e._v(" to "),a("code",[e._v("false")]),e._v(" and\nproviding a response as "),a("code",[e._v("request.response")]),e._v(". If you do this,\nthe HTTP service will send the response back out through any previous middleware\nand out to the client without letting the request continue to the controller.")]),a("p",[e._v("This can be useful for redirecting or throwing errors based on conditions\ndetected in the middleware.")]),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("function")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("handle")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("if")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("!")]),e._v("request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("user"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    \n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("shouldContinue "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[e._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    \n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("let")]),e._v(" response "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("HttpResponse")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[e._v("redirect")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[e._v('"/login"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n    request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("response "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" response"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("return")]),e._v(" request"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])])])}],!1,null,null,null);t.default=n.exports}}]);